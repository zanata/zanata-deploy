#!/bin/bash

set -e

function print_usage(){
    cat <<-END
SYNOPSIS
    zanata-nexus-staging [options] <MODULE>
    zanata-nexus-staging-tennera   [options]
    zanata-nexus-staging-openprops [options]
    zanata-nexus-staging-parent    [options]
    zanata-nexus-staging-api       [options]
    zanata-nexus-staging-common    [options]
    zanata-nexus-staging-client    [options]
    zanata-nexus-staging-assets    [options]

OPTIONS
    -h: Show this help
    -b: Big release.
        Integration/master need to be updated.
        (e.g. when releasing from 3.7.X -> 3.8.0).
        If not specified, only the default branch will be touch
        (e.g. when releasing from 3.7.0 -> 3.7.1 ).
	Default branch is:
	  release if it has release; otherwise
	  integration/master if it has release; otherwise
	  master.

    -r: Skip release plugin

DESCRIPTION
    This program perform the release and push the relese with nexus.
It can do following tasks:

 * For making a big release (e.g. 3.Y.Z -> 4.0.0 or 3.7.Z -> 3.8.0 ), run:

   zanata-nexus-staging-<module> -b

   It will commit to both RELEASING_BRANCH and DEVEL_BRANCH, see 
   section ENVIRONMENT for details.

 * For making a Z release (e.g. 3.7.0 -> 3.7.1 ), run 

   zanata-nexus-staging-<module>

   It will commit to RELEASING_BRANCH.

 * If tag is made but release failed, and you fixed it without changing 
   the source, You can resume the release process with 
  
   zanata-nexus-staging-<module> -r


ENVIRONMENT
    RELEASING_BRANCH
      The branch that release process should be working at. It is:
         'release' if that branch branch exists; otherwise
         'integration/master' if that branch exists; otherwise
         'master'.
 
    DEVEL_BRANCH 
      The branch for new features. It is:
         'integration/master' if that branch exists; otherwise
         'master'.
	
    WORK_ROOT
      The base directory for repository checkout
      As maven release plugin generally require a clean git working tree
      This script will clean it for you.
      Thus it is better not use normal working directory.
	
    REPO_LOCAL_DIR (Optional)
      The directory for maven repo
      This should NOT be your normal work maven repo
	
EXIT_STATUS
    EXIT_INVALID_OPTIONS=3
    EXIT_FAIL_TO_CLONE=4
    EXIT_RELEASE_GOAL_FAIL=5
END
}

function echo_stderr(){
    echo "$1" > /dev/stderr
}

function ensure_repo(){
    local module=$1
    echo "### Ensure the repo $module is at ${WORK_ROOT}/${module}"
    local git_repo_url="git@github.com:zanata/${module}.git"
    pushd ${WORK_ROOT}
    if [ ! -d ${module} ];then
        git clone ${git_repo_url}
        if [ $? -ne 0 ];then
	    echo_stderr "[ERROR] Failed to clone ${git_repo_url}"
	    exit ${EXIT_FAIL_TO_CLONE}
       fi
    fi
    popd
}

function does_branch_exist(){
    local module=$1
    local branch=$2

    ensure_repo ${module}
    pushd ${WORK_ROOT}/${module}
    echo -n "### Does ${module} has branch ${branch}?..."

    if git rev-parse --verify ${branch} &>/dev/null;then
        echo "yes" 
        return 0
    else
        echo "no"
        return 1 
    fi
    popd
}

: ${WORK_ROOT:=/tmp/zanata}
: ${REPO_LOCAL_DIR:=/tmp/maven-central-release-repo}

EXIT_INVALID_OPTIONS=3
EXIT_FAIL_TO_CLONE=4
EXIT_RELEASE_GOAL_FAIL=5

BIG_RELEASE=
SKIP_RELEASE_PLUGIN=

while getopts "brh" opt;do
    case $opt in
	h )
	    pring_usage
	    exit 0
	    ;;
        b )
	    BIG_RELEASE=1
	    ;;
	r )
	    SKIP_RELEASE_PLUGIN=1
	    ;;
	* )
	    echo "Invalid option $opt" > /dev/stderr
	    exit ${EXIT_INVALID_OPTIONS}
	    ;;
    esac
done

shift $((OPTIND-1))
if [ -n "$1" ];then
    MODULE="$1"
fi

case $0 in
    *-tennera)
	MODULE=tennera
        ;;
    *-openprops)
	MODULE=openprops
	;;
    *-parent)
	MODULE=zanata-parent
	;;
    *-api)
	MODULE=zanata-api
	;;
    *-common)
	MODULE=zanata-common
	;;
    *-assets)
	MODULE=zanata-assets
	;;
    *-client)
	MODULE=zanata-client
	;;
    *)
	if [ -z "$MODULE" ]; then
	    print_usage
	    exit ${EXIT_INVALID_OPTIONS}
	fi
	;;
esac

if [ ! -d ${WORK_ROOT} ];then
    mkdir -p ${WORK_ROOT}
fi

### Determine RELEASING_BRANCH

if [ -z "${RELEASING_BRANCH}" ];then
     if does_branch_exist ${MODULE} origin/release ;then
         RELEASING_BRANCH=release
     elif does_branch_exist ${MODULE} origin/integration/master ;then
         RELEASING_BRANCH=integration/master
     else
         RELEASING_BRANCH=master
    fi
fi
echo "### RELEASING_BRANCH for $MODULE is ${RELEASING_BRANCH}"  

### Determine DEVEL_BRANCH, the branch the new feature developer 
### will normally submit. 
### DEVEL_BRANCH is integration/master if it exist, otherwise
### it is master

if does_branch_exist ${MODULE} origin/integration/master ;then
    DEVEL_BRANCH=integration/master
else
    DEVEL_BRANCH=master
fi
echo "### DEVEL_BRANCH for $MODULE is ${DEVEL_BRANCH}"  

cd ${WORK_ROOT}/${MODULE}
git fetch

echo "### [pre-release] ============================== Start"
echo "### [pre-release] updating existing RELEASING_BRANCH (${RELEASING_BRANCH})"
git checkout ${RELEASING_BRANCH}

echo "### [pre-release] Branch ${RELEASING_BRANCH}: merge origin/${RELEASING_BRANCH}"
git merge origin/${RELEASING_BRANCH} --ff-only --quiet

if [ -n "${BIG_RELEASE}" -a "${RELEASING_BRANCH}" != "master" ];then
    echo "### [pre-release] Branch ${RELEASING_BRANCH}: merge origin/master as we do the big release"
    git merge origin/master --ff-only --quiet

    echo "### [pre-release] Branch ${RELEASING_BRANCH}: pushing back to origin"
    git push origin ${RELEASING_BRANCH}
fi

### Update existing DEVEL_BRANCH on BIG_RELEASE
if [ -n "${BIG_RELEASE}" ]; then
    echo "### Pre-release: update existing DEVEL_BRANCH (${DEVEL_BRANCH}) for big release"
    git checkout ${DEVEL_BRANCH}

    echo "### [pre-release] Branch ${DEVEL_BRANCH} merge origin/${DEVEL_BRANCH}"
    git merge origin/${DEVEL_BRANCH} --ff-only --quiet

    echo "### [pre-release] Branch ${DEVEL_BRANCH}: Create new version"
    mvn -e release:update-versions -DautoVersionSubmodules=true

    git commit $(find . -name 'pom.xml' | xargs ) -m "prepare for next development iteration"
    git push origin ${DEVEL_BRANCH}
    echo "### [pre-release] ${DEVEL_BRANCH} branch updated"
fi

echo "### [pre-release] back to RELEASING_BRANCH (${RELEASING_BRANCH})"
git checkout ${RELEASING_BRANCH}
git fetch --tags
git pull

echo "### [release] ============================== Start"
function release_perform(){
    if [ -z "${SKIP_RELEASE_PLUGIN}" ];then
        git clean -f -d

        ### Other MODULEs might related to zanata-parent
        if [ "$MODULE" != "zanata-parent" ];then
             ensure_repo zanata-parent
        fi
        
        echo "### [release_perform] ============================== Start" 
        echo "###it should sign artifacts, push $MODULE to nexus, then close it"
        mvn -e -Dmaven.repo.local=$REPO_LOCAL_DIR -Dgpg.useagent release:clean release:prepare release:perform
        if [ $? -ne 0 ];then
	    echo_stderr "### [ERROR]: release goals failed"
	    exit ${EXIT_RELEASE_GOAL_FAIL}
        fi
    fi
    echo "### [release_perform] Done"
    return 0
}

case $MODULE in
    zanata-parent | zanata-api | zanata-common | zanata-assets )
	release_perform

        echo "### [release] nexus-staging:release"
	mvn -e nexus-staging:release -Psonatype-oss-release \
	    -DstagingRepositoryId=$(grep -oP '^stagingRepository\.id=\K.*' target/checkout/target/nexus-staging/staging/*.properties)
	;;
    zanata-client )
	### auto nexus-staging does not seem to work with zanata-client
	### Need to use manual bundle jars
	release_perform

        ### Create and sign the artifacts
        echo "### [release] Create and sign the artifacts"
	mvn -e clean deploy source:jar javadoc:jar jar:jar gpg:sign -Dgpg.useagent -DskipTests=true -DskipArqTests=true -Dfindbugs.skip=true 

	### make bundles for each submodules:
	SUBMODULES=(. zanata-cli zanata-client-commands zanata-maven-plugin zanata-rest-client)
	BUNDLE_JARS=()
	for sm in "${SUBMODULES[@]}"; do
	    pushd ${sm}/target
	    jar cvf bundle.jar $(for i in `LANG=C find . -name  "*.asc" | sed -e 's/.asc$//' | xargs`;do echo -n $i $i.asc " ";done)
	    BUNDLE_JARS+="${sm}/target/bundle.jar"
	    popd
	done

	### Notify user to upload bundles
	cat <<-END
	Please:
	1. Login to oss.sonatype.org
	2. On Left panel, under Build Promotion section, click Staging Upload
	3. Upload following files:
	END

	for bj in "${BUNDLE_JARS[@]}"; do
	    echo "$bj"
	done
	;;

    * )
	### MODULE like tennera or openprops
	### These have only master
	release_perform
	mvn -e nexus-staging:close nexus-staging:release
	;;
esac

