#!/usr/bin/env groovy
/**
 * Jenkinsfile for zanata-scripts
 */

@Field
public static final String ORG_BASE = 'github.com/zanata'

@Field
public static final String PIPELINE_LIBRARY_BRANCH = 'v0.3.1'

@Library('github.com/zanata/zanata-pipeline-library@v0.3.1')
import org.zanata.jenkins.Notifier
import org.zanata.jenkins.PullRequests
import org.zanata.jenkins.ScmGit
import static org.zanata.jenkins.StackTraces.getStackTrace

import groovy.transform.Field

@Field
def pipelineLibraryScmGit

@Field
def zanataScriptScmGit

@Field
def mainScmGit

@Field
def notify

timestamps {
// We need a node with release label
  node('release') {
    currentBuild.displayName = currentBuild.displayName + " {${env.NODE_NAME}}"

    // To override following variables, use
    // "Properties Content" in "Prepare an environment for the run" in Jenkins Web UI
    String REPO_NAME = (env.REPO_NAME) ?: 'zanata-platform'
    String PROJ_BASE = (env.PROJ_BASE) ?: "${ORG_BASE}/${REPO_NAME}"
    String PROJ_BRANCH = (env.PROJ_BRANCH) ?: 'release'
    String ZANATA_SCRIPTS_BRANCH = (env.ZANATA_SCRIPTS_BRANCH) ?: 'master'
    String WORK_ROOT = (env.WORK_ROOT) ?: "/home/jenkins/zanata-work-root"
    String WORK_DIR = "${WORK_ROOT}/${REPO_NAME}"

    String releaseVersion = null

    ansiColor('xterm') {
      pipelineLibraryScmGit = new ScmGit(env, steps, "https://${ORG_BASE}/zanata-pipeline-library")
      pipelineLibraryScmGit.init(PIPELINE_LIBRARY_BRANCH)
      zanataScriptsScmGit = new ScmGit(env, steps, "https://${ORG_BASE}/zanata-scripts")
      zanataScriptsScmGit.init(ZANATA_SCRIPTS_BRANCH)
      mainScmGit = new ScmGit(env, steps, "https://${PROJ_BASE}")
      mainScmGit.init(PROJ_BRANCH)
      notify = new Notifier(env, steps, currentBuild,
          pipelineLibraryScmGit, mainScmGit, 'maven-Jenkinsfile',
      )

      def projectProperties = [
        [
          $class: 'BuildDiscarderProperty',
          strategy: [$class: 'LogRotator',
            numToKeepStr: '20',        // keep records for at most X builds
            artifactDaysToKeepStr: '', // keep artifacts no more than X days
            artifactNumToKeepStr: '10', // keep artifacts for at most X builds
          ]
        ],
        [$class: 'GithubProjectProperty',
          projectUrlStr: "https://${PROJ_BASE}"
        ],
        [$class: 'ParametersDefinitionProperty',
          parameterDefinitions: [
            [$class: 'StringParameterDefinition',
              defaultValue: 'auto',
              description: 'Version to release like "4.4.0", "4.4.0-alpha-1", or "auto" to release the SNAPSHOT',
              name: 'RELEASE_VERSION'
            ],
            [$class: 'StringParameterDefinition',
              defaultValue: 'testBuild',
              description: '"" for build and commit; "testBuild" for build but not commit; "dryRun" for knowing commands to be run ',
              name: 'ZANATA_RELEASE_MODE'
            ],
          ]
        ],
      ]

      properties(projectProperties)
    }


    if (params.ZANATA_RELEASE_MODE != "" ){
      currentBuild.displayName = currentBuild.displayName + " [${params.ZANATA_RELEASE_MODE}]"
    }

    stage('Checkout') {
      notify.started()

      // This checkout zanata-scripts
      checkout scm

      String artifactId = sh(returnStdout: true,
          script: "bash $WORKSPACE/zanata-functions run get_artifact_id ${REPO_NAME}"
      ).trim()

      withEnv(["WORK_ROOT=$WORK_ROOT","ZANATA_GIT_URL_PREFIX=https://${ORG_BASE}"]) {
        sh("bash $WORKSPACE/zanata-functions run ensure_repo ${REPO_NAME}")
        sh("bash $WORKSPACE/zanata-functions run checkout_branch ${REPO_NAME} ${PROJ_BRANCH} ${WORK_ROOT}")
        dir(WORK_DIR) {
//          git branch: PROJ_BRANCH, changelog: false, credentialsId: 'zanata-jenkins', poll: false, url: "https://${PROJ_BASE}.git"

          if (params.RELEASE_VERSION == 'auto') {
            if (REPO_NAME == 'zanata-platform') {
              releaseVersion = readMavenPom(file: "${WORK_DIR}/parent/pom.xml").getVersion().replaceAll('-SNAPSHOT', '')
            } else {
              releaseVersion = readMavenPom(file: "${WORK_DIR}/pom.xml").getVersion().replaceAll('-SNAPSHOT', '')
            }
          } else {
            releaseVersion = params.RELEASE_VERSION
          }

          currentBuild.displayName = currentBuild.displayName + " $releaseVersion"
          tagName = "${artifactId}-${releaseVersion}"

          developmentVersion = sh(returnStdout: true,
            script: "bash $WORKSPACE/zanata-functions run version_next $releaseVersion",
          ).trim() + '-SNAPSHOT'
          echo "Release Version=$releaseVersion     Development Version=$developmentVersion"

          // Is this version already been tag/build ?
          String remoteTagLine = sh(returnStdout: true,
            script: "git ls-remote https://github.com/zanata/$REPO_NAME refs/tags/${tagName}",
          )?.trim()
          if ( remoteTagLine ){
            error "tag ${tagName} is already in remote"
          }

          def tagExistExitStatus = sh(returnStatus: true,
            script: "git show-ref ${tagName}",
          )
          if ( tagExistExitStatus == 0 ){
            // Remove only local tag (possibly from a failed build)
            sh "git tag -d $tagName"
          }
        }
      }
    }

    def envArray = new ArrayList()
    envArray.addAll(
      sh( returnStdout: true,
        script: "sed -rn -e '/[A-Z_]*=/ s/^[^A-Z_]*([A-Z_]*=[^}]*)/\\1/p' $WORKSPACE/zanata-env.sh",
      )?.split("\n")
    )

    envArray.addAll([
      "WORK_ROOT=${WORK_ROOT}",
      "ZANATA_RELEASE_MODE=${params.ZANATA_RELEASE_MODE}",
    ])

    if (params.ZANATA_RELEASE_MODE == 'dryRun') {
      envArray.add("DryRunMode=1")
    }

    withEnv(envArray) {
      String developmentVersion = null
      String tagName = null

      dir (WORK_DIR) {
        String releaseNoteVersion = releaseVersion.replaceAll('-.*','')
        stage('ReleaseNotes') {
          notify.startBuilding()
          echo "releaseNoteVersion: $releaseNoteVersion"
          def releaseNoteStatus = sh(returnStatus: true,
            script: "bash $WORKSPACE/zanata-release-notes-prepend -j $artifactId $releaseNoteVersion",
          )
          echo "releaseNoteStatus: $releaseNoteVersion"
          switch(releaseNoteStatus) {
            case 0: // EXIT_OK
              // ReleaseNotes updated. Git commit is done by zanata-release-notes-prepend
              break
            case 40: // EXIT_RETURN_FALSE
              // ReleaseNotes does not changed
              break
            default:
              error "Status($releaseNoteStatus) Failed to get related jira issues"
              break
          }
        }

        stage('SetReleaseVersion') {
          sh(returnStatus: true,
            script: "bash $WORKSPACE/zanata-pom-set-version ${artifactId}- $releaseVersion $PLATFORM_MAVEN_VERSION_PROJECT",
          )
        }
        // We cannot use org.sonatype.plugins:nexus-staging-maven-plugin:1.6.8:deploy here
        // It generate following error
        // [ERROR] Failed to execute goal org.sonatype.plugins:nexus-staging-maven-plugin:1.6.8:deploy (default-cli) on project build-tools: The packaging for this project did not assign a file to the build artifact
        //stage('Nexus') {
        //  sh "bash $WORKSPACE/zanata-nexus $PLATFORM_MAVEN_NEXUS_RELEASE_PROJECTS"
        //}
        stage('NexusStaging') {
          sh "bash $WORKSPACE/zanata-nexus-staging $PLATFORM_MAVEN_NEXUS_RELEASE_PROJECTS"
        }
        stage('NexusRelease') {
          sh "bash $WORKSPACE/zanata-nexus-release -p $PLATFORM_MAVEN_NEXUS_RELEASE_PROJECTS"
        }
        stage('SetSnapshotVersion') {
          sh(returnStatus: true,
            script: "bash $WORKSPACE/zanata-pom-set-version ${artifactId}- $developmentVersion $PLATFORM_MAVEN_VERSION_PROJECT",
          )
          withCredentials([
            [$class: 'UsernamePasswordMultiBinding',
              credentialsId: 'zanata-jenkins',
              usernameVariable: 'GIT_USERNAME', passwordVariable: 'GITHUB_OAUTH2_TOKEN'
            ]
          ]) {
            if ( params.ZANATA_RELEASE_MODE == '') {
              sh "git push https://$GIT_USERNAME:$GITHUB_OAUTH2_TOKEN@${PROJ_BASE} release"
            }
          }
        }
      }
      stage('ArtifactList') {
        sh("bash $WORKSPACE/zanata-artifact-m2repo -l | sort -u > artifact-list.txt")
        archiveArtifacts(artifacts: 'artifact-list.txt')
      }
    }
  }
}


